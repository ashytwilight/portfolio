<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>LINE Pay Confirm 測試</title>
    <script>
      async function confirmPayment() {
        const channelId = '2007230020';
        const channelSecret = '98046e36ef3274e1b1f5f7d7ec4dba06'; // ✅ sandbox key
        const transactionId = document.getElementById('transactionId').value;
        const amount = document.getElementById('amount').value;
        const currency = document.getElementById('currency').value;
        const nonce = crypto.randomUUID(); // ✅ UUIDv4

        const body = JSON.stringify({
          amount: Number(amount),
          currency: currency,
        });

        // ✅ 1. 生成 HMAC-SHA256 簽章
        const encoder = new TextEncoder();
        const keyData = encoder.encode(channelSecret);
        const msgData = encoder.encode(channelSecret + nonce + body);
        const cryptoKey = await crypto.subtle.importKey(
          'raw',
          keyData,
          { name: 'HMAC', hash: 'SHA-256' },
          false,
          ['sign']
        );
        const signature = await crypto.subtle.sign('HMAC', cryptoKey, msgData);
        const authorization = btoa(
          String.fromCharCode(...new Uint8Array(signature))
        );

        // ✅ 2. 發送 Confirm 請求
        const response = await fetch(
          `https://sandbox-api-pay.line.me/v3/payments/${transactionId}/confirm`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-LINE-ChannelId': channelId,
              'X-LINE-Authorization-Nonce': nonce,
              'X-LINE-Authorization': authorization,
            },
            body: body,
          }
        );

        const result = await response.json();
        document.getElementById('result').textContent = JSON.stringify(
          result,
          null,
          2
        );
      }
    </script>
  </head>
  <body>
    <h1>LINE Pay Confirm 測試</h1>
    <input type="text" id="transactionId" placeholder="Transaction ID" /><br />
    <input type="number" id="amount" placeholder="金額" /><br />
    <input type="text" id="currency" value="TWD" /><br />
    <button onclick="confirmPayment()">送出</button>
    <pre id="result"></pre>
  </body>
</html>
